"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("cross-fetch"),e=require("pako"),s=require("wildcard-match"),r=require("flat"),n=class{static get(t){return this.safeEnvLookup(t)}static set(t,e){return this._overrides.set(t,e)}static alias(t,e){return this._aliases.set(t,e)}static attachConfigRegistry(t){this._registry=t}static attachConfigFactory(t){this._factory=t}static reset(){this._overrides=new Map,this._registry=void 0,this._factory=void 0}static safeEnvLookup(t){let e=[];this._overrides.get(t)&&e.push(this._overrides.get(t)),"object"==typeof this._registry&&e.push(this._registry[t]),"function"==typeof this._factory&&e.push(this._factory(t)),"object"==typeof process&&"object"==typeof process.env&&e.push(process.env[t]),e.push(...this.checkForBrowserVariables(t));const s=e.find((t=>void 0!==t));if(void 0!==s)return s;const r=this._aliases.get(t);return r?this.safeEnvLookup(r):void 0}static checkForBrowserVariables(t){let e=[];if("object"==typeof window){const s=window[`CROSSENV_${t}`];if(void 0!==s&&e.push(s),"object"==typeof sessionStorage){const s=sessionStorage.getItem(`CROSSENV_${t}`);null!==s&&e.push(s)}}return e}};n._overrides=new Map,n._aliases=new Map;class i{constructor(t,e){const s=n.get("AGENT_INTERNAL_URL")||"http://localhost:3000",r=n.get("FLATFILE_BEARER_TOKEN");this._accessToken=t||r||"...",this._apiUrl=e||s?(t=>{for(;t.endsWith("/");)t=t.slice(0,-1);return t+"/"})(e||s):void 0}async fetch(e,s){const r={Authorization:`Bearer ${this._accessToken}`,"x-disable-hooks":"true","Content-Type":"application/json",...s?.headers},n=this._apiUrl+e,i={method:s?.method||"GET",headers:r,body:s?.data};try{const e=await t(n,i);if(e.status>=200&&e.status<=399){const t=e.headers.get("content-type");if(t&&t.includes("application/json")){return(await e.json()).data}return await e.text()}throw new Error(`HTTP error! Status: ${e.status}`)}catch(t){console.log("event.fetch error: ",t)}}setVariables({accessToken:t,apiUrl:e}){this._accessToken=t,this._apiUrl=e}}class a{constructor(){this.eventCache=new Map}async init(t,e){if(this.eventCache.get(t))return this.eventCache.get(t);{const s=await e();return this.eventCache.set(t,s),s}}async set(t,e){if(this.eventCache.get(t)){const s=await e();return this.eventCache.set(t,s),s}throw new Error("Cache key not found")}get(t){if(this.eventCache.get(t))return this.eventCache.get(t);throw new Error("Cache key not found")}delete(t){if(t){if(!this.eventCache.get(t))throw new Error("Cache key not found");Array.isArray(t)?t.forEach((t=>this.eventCache.delete(t))):this.eventCache.delete(t)}else this.eventCache.clear()}}class o extends i{constructor(t,e,s){super(e,s),this.src=t,this.afterAllCallbacks=new Map,this.cache=new a,this.domain=t.domain,this.topic=t.topic,this.context=t.context,this.payload=t.payload,this.target=t.target||"",this.origin=t.origin||{},this.action=t.context?.actionName||"",this.namespace=t.namespaces||[],this.createdAt=t.createdAt||void 0;const r=async t=>this.fetchData(t);r.then=(t,e)=>this.data().then(t,e),this.data=r}async fetchData(t){const e=new URLSearchParams(this.src.dataUrl);if(t)for(const[s,r]of Object.entries(t))if(Array.isArray(r))for(const t of r)e.append(s,t);else e.append(s,r);const s=decodeURIComponent(e.toString());return s?this.fetch(s):this.payload}afterAll(t,e){const s=e||t.toString();this.afterAllCallbacks.get(s)||this.afterAllCallbacks.set(s,t)}async update(t,s=!0){if(!this.src.dataUrl)throw new Error("Cannot set data on an event without a dataUrl");t.map((t=>{t.messages?.map((t=>{delete t.source}))}));const r=s?e.gzip(JSON.stringify(t)):t,n=s?{"Content-Encoding":"gzip","Content-Length":r.length.toString()}:{};await this.fetch(this.src.dataUrl,{method:"PUT",headers:n,data:r})}async secrets(t,e){const s=e?.environmentId||this.context.environmentId||"",r=e?.spaceId||this.context.spaceId||"";if(!s)throw new Error("environmentId is required to fetch secrets");let n=`v1/secrets?environmentId=${s}`;r&&(n+=`&spaceId=${r}`);const i=`secrets:${s}${r&&`:${r}`}`,a=(await this.cache.init(i,(async()=>{const t=await this.fetch(n),e=new Map;return t?.forEach((t=>{e.set(t.name,t.value)})),e}))).get(t);if(!a)throw new Error(`Secret ${t} not found`);return a}}function c(t,e){return!(!t||"string"!=typeof t)&&s(e||"**",":")(t)}function h(t,e){e=e.includes("*")||e.includes(".")?e:`**.${e}`;const r=s(e,".");return Object.keys(t).filter((t=>r(t)))}function l(t,e){return null==t?null===e:Array.isArray(t)?t.some((t=>l(t,e))):"string"==typeof e?c(t.toString(),e):t===e}class d extends i{constructor(t,e,s){super(e,s),this.listeners=[],this.nodes=[],t&&(this.filterQuery=t)}on(t,...e){let s={};const r=e.pop();return e.length&&(s=e.shift()),this.listeners.push([t,s,r]),this}addNode(t){return this.nodes.push(t),this}async dispatchEvent(t){if(!t)return;const e=t.src?t.src:t;t=new o(e,this._accessToken,this._apiUrl),await this.trigger(t,!0);for(const[e,s]of t.afterAllCallbacks)await s(t);t.cache.delete()}async routeEvent(t){return this.dispatchEvent(t)}async trigger(t,e=!1){const s=this.getListeners(t,e);for(const e of s)await e.callback(t)}getListeners(t,e=!1){if(!this.matchEvent(t,this.filterQuery))return[];const s=this.listeners.filter((([e,s])=>{const r=c(t.topic,e),n=this.matchEvent(t,s);return r&&n})).map((([t,e,s])=>({query:t,filter:e,callback:s})));return e?[...s,...this.nodes.flatMap((e=>e.getListeners(t,!0)))]:s}use(t){return t(this),this}matchEvent(t,e){return!e||function(t,e){const s=e&&"object"==typeof e?e:{"**":e};if("object"!=typeof t)throw new Error("You cannot filter a non-object");let n=!1;const i=r(s,{safe:!0}),a=r(t,{safe:!0});for(const t in i){const e=h(a,t),s=Array.isArray(i[t])?i[t]:[i[t]];n||(n=!e.some((t=>{const e=a[t];return s.some((t=>l(e,t)))})))}return!n}(t,e)}}class u extends d{namespace(t,e){return this.filter({namespaces:t},e)}filter(t,e){const s=new this.constructor(t);return this.addNode(s),e?.(s),s}static create(t){const e=new this;return t(e),e}mount(t){return t.mountEventHandler(this),this}}class p{get handler(){if(!this._handler)throw new Error("handler not registered yet");return this._handler}mountEventHandler(t){return this._handler=t,this}dispatchEvent(t){return this.handler.dispatchEvent(t),this}}exports.AuthenticatedClient=i,exports.Browser=class extends p{constructor({apiUrl:t,accessToken:e,environmentId:s}){super(),this._apiUrl=t,this._accessToken=e,this._environmentId=s||""}mountEventHandler(t){return t.setVariables({accessToken:this._accessToken,apiUrl:this._apiUrl}),this._handler=t,this}},exports.Client=class extends u{},exports.EventDriver=p,exports.EventHandler=d,exports.FlatfileEvent=o,exports.FlatfileListener=u,exports.FlatfileVirtualMachine=class extends p{handle(t){this.dispatchEvent(t)}mountEventHandler(t){return this._handler=t,this}},exports.default=u;
